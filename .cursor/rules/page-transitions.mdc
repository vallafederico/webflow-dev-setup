---
description: Patterns and rules for the page transition system using Taxi.js and custom module lifecycles. Use when modifying transitions, handling page changes, or implementing cross-page logic.
globs: src/lib/pages.ts, src/lib/page-transitions.ts, src/modules/_/cycle.ts
alwaysApply: false
---
# Page Transition System Rules

## Overview
The project uses `@unseenco/taxi` for client-side navigation. This system is tightly integrated with the custom module lifecycle hooks (`onPageIn`, `onPageOut`, `onMount`, `onDestroy`).

## Core Components
- `src/lib/pages.ts`: Extends Taxi's `Core`, manages the sequence of lifecycle runs during transitions.
- `src/lib/page-transitions.ts`: Defines Taxi `Transition` classes that bridge Taxi's `onLeave`/`onEnter` with our custom `transitionOut`/`transitionIn`.

## Transition Lifecycle Sequence

### 1. `transitionOut` (Page Exit)
When navigating away from a page:
1. `runPageOut()`: Triggers all `onPageOut` hooks in active modules. These should return promises for exit animations.
2. `runDestroy()`: Cleans up all modules on the current page.
3. `Scroll.toTop()`: Resets scroll position for the incoming page.

### 2. `transitionIn` (Page Entrance)
When the new page content is ready:
1. `createCycles()`: Scans the new DOM for `data-module` attributes and initializes modules.
2. `Scroll.resize()` / `Resize.update()`: Recalculates layout metrics for the new page.
3. `runPageIn()`: Triggers all `onPageIn` hooks in the new modules. These should return promises for entrance animations.
4. `runMount()`: Runs the `onMount` hooks for all new modules.

## Implementation Rules
- **Non-Blocking**: Transitions should ideally wait for animations (`await runPageIn()`) before finishing.
- **Cleanup**: Always ensure `runDestroy()` is called to prevent memory leaks from previous page modules.
- **Link Filtering**: Taxi is configured via `PAGES_CONFIG.links` to ignore specific links (e.g., `#` anchors, `target="_blank"`, `[data-taxi-ignore]`).
- **Initial Load**: Use `runInitial()` on the first page load to kickstart the cycle without a full transition.

## Adding Custom Transitions
To add a specific transition for certain pages:
1. Define a new class in `src/lib/page-transitions.ts` extending `BaseTransition`.
2. Register it in `src/lib/pages.ts` within the `transitions` object of the `_Pages` class.
